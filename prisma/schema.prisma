generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum BreakpointAxis {
  width
  height

  @@map("breakpoint_axis")
}

enum UnitPreference {
  mm
  cm

  @@map("unit_preference")
}

enum GdprRequestType {
  CUSTOMERS_DATA_REQUEST
  CUSTOMERS_REDACT
  SHOP_REDACT

  @@map("gdpr_request_type")
}

enum ModifierType {
  FIXED
  PERCENTAGE

  @@map("modifier_type")
}

enum GroupRequirement {
  REQUIRED
  OPTIONAL

  @@map("group_requirement")
}

model Store {
  id                      String             @id @default(cuid())
  shop                    String             @unique
  accessToken             String?            @map("access_token")
  apiKeyHash              String?            @map("api_key_hash")
  apiKeyPrefix            String?            @map("api_key_prefix")
  onboardingCompleted     Boolean            @default(false) @map("onboarding_completed")
  unitPreference          UnitPreference     @default(mm) @map("unit_preference")
  currency                String             @default("USD")
  totalDraftOrdersCreated Int                @default(0) @map("total_draft_orders_created")
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")
  matrices                PriceMatrix[]
  draftOrderRecords       DraftOrderRecord[]
  optionGroups            OptionGroup[]

  @@map("stores")
}

model GdprRequest {
  id          Int              @id @default(autoincrement())
  shop        String
  type        GdprRequestType
  payload     Json
  processedAt DateTime?        @map("processed_at")
  createdAt   DateTime         @default(now()) @map("created_at")

  @@index([shop])
  @@index([type])
  @@map("gdpr_requests")
}

model PriceMatrix {
  id                String             @id @default(cuid())
  storeId           String             @map("store_id")
  name              String
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  store             Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  breakpoints       Breakpoint[]
  cells             MatrixCell[]
  products          ProductMatrix[]
  draftOrderRecords DraftOrderRecord[]

  @@index([storeId])
  @@map("price_matrices")
}

model Breakpoint {
  id       Int            @id @default(autoincrement())
  matrixId String         @map("matrix_id")
  axis     BreakpointAxis
  value    Float
  position Int
  matrix   PriceMatrix    @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@unique([matrixId, axis, value])
  @@map("breakpoints")
}

model MatrixCell {
  id             Int         @id @default(autoincrement())
  matrixId       String      @map("matrix_id")
  widthPosition  Int         @map("width_position")
  heightPosition Int         @map("height_position")
  price          Float
  matrix         PriceMatrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@unique([matrixId, widthPosition, heightPosition])
  @@map("matrix_cells")
}

model ProductMatrix {
  id           Int                   @id @default(autoincrement())
  matrixId     String                @map("matrix_id")
  productId    String                @map("product_id")
  productTitle String                @map("product_title")
  assignedAt   DateTime              @default(now()) @map("assigned_at")
  matrix       PriceMatrix           @relation(fields: [matrixId], references: [id], onDelete: Cascade)
  optionGroups ProductOptionGroup[]

  @@unique([productId])
  @@index([matrixId])
  @@map("product_matrices")
}

model DraftOrderRecord {
  id                  Int         @id @default(autoincrement())
  storeId             String      @map("store_id")
  matrixId            String      @map("matrix_id")
  shopifyDraftOrderId String      @map("shopify_draft_order_id")
  shopifyOrderName    String      @map("shopify_order_name")
  productId           String      @map("product_id")
  width               Float
  height              Float
  quantity            Int
  calculatedPrice     Float       @map("calculated_price")
  totalPrice          Float       @map("total_price")
  optionSelections    Json?       @map("option_selections")
  createdAt           DateTime    @default(now()) @map("created_at")
  store               Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  matrix              PriceMatrix @relation(fields: [matrixId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([matrixId])
  @@index([shopifyDraftOrderId])
  @@map("draft_order_records")
}

model OptionGroup {
  id          String                @id @default(cuid())
  storeId     String                @map("store_id")
  name        String
  requirement GroupRequirement      @default(OPTIONAL)
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")
  store       Store                 @relation(fields: [storeId], references: [id], onDelete: Cascade)
  choices     OptionChoice[]
  products    ProductOptionGroup[]

  @@index([storeId])
  @@map("option_groups")
}

model OptionChoice {
  id            String        @id @default(cuid())
  optionGroupId String        @map("option_group_id")
  label         String
  modifierType  ModifierType  @map("modifier_type")
  modifierValue Int           @map("modifier_value")
  isDefault     Boolean       @default(false) @map("is_default")
  createdAt     DateTime      @default(now()) @map("created_at")
  optionGroup   OptionGroup   @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  @@index([optionGroupId])
  @@map("option_choices")
}

model ProductOptionGroup {
  id            Int           @id @default(autoincrement())
  productId     String        @map("product_id")
  optionGroupId String        @map("option_group_id")
  assignedAt    DateTime      @default(now()) @map("assigned_at")
  product       ProductMatrix @relation(fields: [productId], references: [productId], onDelete: Cascade)
  optionGroup   OptionGroup   @relation(fields: [optionGroupId], references: [id], onDelete: Cascade)

  @@unique([productId, optionGroupId])
  @@index([productId])
  @@index([optionGroupId])
  @@map("product_option_groups")
}
