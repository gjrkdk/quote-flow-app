---
phase: 16-performance-audit-app-store-submission
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - .lighthouserc.cjs
  - .github/workflows/lighthouse-ci.yml
  - package.json
autonomous: true

must_haves:
  truths:
    - "All foreign key columns (storeId, productId, optionGroupId, matrixId) have database indexes"
    - "Lighthouse CI runs automatically on push/PR and asserts performance thresholds"
    - "Baseline Lighthouse scores are established for key admin pages"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Verified foreign key indexes"
      contains: "@@index"
    - path: ".lighthouserc.cjs"
      provides: "Lighthouse CI configuration"
      contains: "minScore"
    - path: ".github/workflows/lighthouse-ci.yml"
      provides: "CI workflow for automated performance testing"
      contains: "lhci autorun"
  key_links:
    - from: ".github/workflows/lighthouse-ci.yml"
      to: ".lighthouserc.cjs"
      via: "lhci autorun reads config"
      pattern: "lhci autorun"
---

<objective>
Verify database indexes on all foreign keys and set up automated Lighthouse CI for performance regression monitoring.

Purpose: Success criteria 1 and 5 require performance baseline and proper database indexes. These are foundational for App Store submission.
Output: Verified indexes (migration if needed), Lighthouse CI config, GitHub Actions workflow, baseline performance scores.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-performance-audit-app-store-submission/16-RESEARCH.md
@prisma/schema.prisma
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify database indexes and add migration if needed</name>
  <files>prisma/schema.prisma</files>
  <action>
Audit every foreign key column in the Prisma schema for an explicit index:

**Already indexed (verify these are still present):**
- GdprRequest: @@index([shop]), @@index([type])
- JobQueue: @@index([status, scheduledAt])
- PriceMatrix: @@index([storeId])
- ProductMatrix: @@index([matrixId])
- DraftOrderRecord: @@index([storeId]), @@index([matrixId]), @@index([shopifyDraftOrderId])
- OptionGroup: @@index([storeId])
- OptionChoice: @@index([optionGroupId])
- ProductOptionGroup: @@index([productId]), @@index([optionGroupId])

**Verify ProductMatrix.productId:** Has @@unique([productId]) which creates a unique index in PostgreSQL. This satisfies the index requirement. Document that @@unique implicitly creates an index (no separate @@index needed).

**Check for any other FK columns WITHOUT indexes:**
- Breakpoint.matrixId — has @@unique([matrixId, axis, value]) covering it
- MatrixCell.matrixId — has @@unique([matrixId, widthPosition, heightPosition]) covering it

If ALL FKs are covered (expected), create a brief verification log rather than a migration. If any are missing, add @@index directives and run `npx prisma migrate dev --name add_missing_fk_indexes`.

The output is a verification that all foreign key columns have indexes, either explicit @@index or implicit from @@unique constraints.
  </action>
  <verify>Run `npx prisma validate` to confirm schema is valid. Grep schema for all foreign key fields and confirm each has an index (@@index or @@unique).</verify>
  <done>Every foreign key column in the schema is confirmed to have an index (explicit or via unique constraint). Verification documented.</done>
</task>

<task type="auto">
  <name>Task 2: Set up Lighthouse CI with GitHub Actions workflow</name>
  <files>.lighthouserc.cjs, .github/workflows/lighthouse-ci.yml, package.json</files>
  <action>
1. Install @lhci/cli as a dev dependency:
   `npm install --save-dev @lhci/cli`

2. Create `.lighthouserc.cjs` (use .cjs since package.json has "type": "module"):

```javascript
module.exports = {
  ci: {
    collect: {
      url: [
        'http://localhost:3000/app',
        'http://localhost:3000/app/matrices',
        'http://localhost:3000/app/option-groups'
      ],
      numberOfRuns: 3,
      startServerCommand: 'npm run build && npm run start',
      startServerReadyPattern: 'listening',
      startServerReadyTimeout: 30000,
      settings: {
        preset: 'desktop',
        throttling: {
          rttMs: 40,
          throughputKbps: 10240,
          cpuSlowdownMultiplier: 1
        }
      }
    },
    assert: {
      preset: 'lighthouse:recommended',
      assertions: {
        'categories:performance': ['error', { minScore: 0.8 }],
        'categories:accessibility': ['error', { minScore: 0.9 }],
        'categories:best-practices': ['error', { minScore: 0.8 }],
        'categories:seo': ['off']
      }
    },
    upload: {
      target: 'temporary-public-storage'
    }
  }
};
```

Note: SEO is turned off because this is an embedded Shopify admin app (not a public-facing page). Best practices threshold set to 0.8 (embedded apps have constraints from Shopify App Bridge).

3. Create `.github/workflows/lighthouse-ci.yml`:

```yaml
name: Lighthouse CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: postgresql://localhost:5432/test
      DIRECT_URL: postgresql://localhost:5432/test
      SHOPIFY_API_KEY: test
      SHOPIFY_API_SECRET: test
      SCOPES: write_products,read_customers,write_draft_orders

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm install -g @lhci/cli@0.15.x
      - run: npm run build
      - run: lhci autorun
```

Note: The CI workflow requires database and Shopify env vars to build. These are placeholder values since Lighthouse tests the frontend only (no actual API calls during audit). The build step needs these env vars to compile without errors.

4. Add a convenience script to package.json:
   `"lighthouse": "lhci autorun"`
  </action>
  <verify>Run `npx lhci --version` to confirm installation. Validate `.lighthouserc.cjs` syntax with `node -e "require('./.lighthouserc.cjs')"`. Verify `.github/workflows/lighthouse-ci.yml` is valid YAML.</verify>
  <done>Lighthouse CI installed, configured with 3-run averages on key admin pages, GitHub Actions workflow ready. Performance thresholds set at 0.8 performance and 0.9 accessibility (Shopify's 10-point degradation rule accounted for).</done>
</task>

</tasks>

<verification>
- `npx prisma validate` passes
- All foreign key columns confirmed indexed (via @@index or @@unique)
- `node -e "require('./.lighthouserc.cjs')"` succeeds
- `.github/workflows/lighthouse-ci.yml` exists with proper structure
- `@lhci/cli` in devDependencies
</verification>

<success_criteria>
- Database indexes verified on all foreign key columns (storeId, productId, optionGroupId, matrixId)
- Lighthouse CI configured with performance thresholds matching Shopify's requirements
- GitHub Actions workflow ready to run on push/PR
</success_criteria>

<output>
After completion, create `.planning/phases/16-performance-audit-app-store-submission/16-01-SUMMARY.md`
</output>
