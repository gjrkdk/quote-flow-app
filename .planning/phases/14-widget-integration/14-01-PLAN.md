---
phase: 14-widget-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/api.v1.products.$productId.options.ts
  - packages/widget/src/types.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/products/:productId/options returns option groups with choices for a product"
    - "Widget type system includes OptionGroup, OptionChoice, and OptionSelection types"
    - "API returns empty array (not 404) for products with no option groups"
  artifacts:
    - path: "app/routes/api.v1.products.$productId.options.ts"
      provides: "REST API endpoint for fetching product option groups"
      exports: ["loader"]
    - path: "packages/widget/src/types.ts"
      provides: "Extended type definitions for option groups"
      contains: "OptionGroup"
  key_links:
    - from: "app/routes/api.v1.products.$productId.options.ts"
      to: "app/services/option-group.server.ts"
      via: "getProductOptionGroups service call"
      pattern: "getProductOptionGroups"
---

<objective>
Create the REST API endpoint that exposes product option groups to the widget, and extend the widget type system with option-related types.

Purpose: The widget needs a way to discover which option groups are assigned to a product. Phase 13 extended the price and draft-order endpoints with options support, but no endpoint exists to list option groups for a product. The types form the foundation for all subsequent widget work.

Output: Working `GET /api/v1/products/:productId/options` endpoint + extended widget types
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/routes/api.v1.products.$productId.price.ts
@app/services/option-group.server.ts
@app/utils/api-auth.server.ts
@app/validators/api.validators.ts
@packages/widget/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/v1/products/:productId/options REST endpoint</name>
  <files>app/routes/api.v1.products.$productId.options.ts</files>
  <action>
Create a new Remix resource route at `app/routes/api.v1.products.$productId.options.ts` that exposes option groups for a product.

Follow the exact same patterns used in `api.v1.products.$productId.price.ts`:
- CORS preflight handling (withCors helper with Access-Control-Allow-Origin: *, methods GET/OPTIONS, headers X-API-Key/Content-Type)
- API key authentication via `authenticateApiKey(request)` from `~/utils/api-auth.server`
- Rate limiting via `checkRateLimit(store.id)` and `getRateLimitHeaders(store.id)` from `~/utils/rate-limit.server`
- Product ID validation via `ProductIdSchema` and `normalizeProductId` from `~/validators/api.validators`
- RFC 7807 error responses for all failure cases
- `action` export for non-GET methods returns 405

The loader should:
1. Handle OPTIONS preflight → 204
2. Authenticate via X-API-Key
3. Rate limit
4. Validate and normalize productId param
5. Call `getProductOptionGroups(normalizedProductId, store.id)` from `~/services/option-group.server`
6. If result is null (product not found/unauthorized), return `{ optionGroups: [] }` with 200 status (NOT 404 — the widget should handle empty gracefully)
7. Return `{ optionGroups: groups }` where each group has: `id`, `name`, `requirement` (REQUIRED/OPTIONAL), and `choices` array. Each choice has: `id`, `label`, `modifierType` (FIXED/PERCENTAGE), `modifierValue` (integer: cents for FIXED, basis points for PERCENTAGE), `isDefault` (boolean)
8. Add CORS and rate limit headers to response

Important: Return empty array for both "product not found" and "no option groups assigned" cases. The widget should not distinguish between these — it simply renders nothing when there are no groups.
  </action>
  <verify>Run `npx tsc --noEmit` from project root to confirm no TypeScript errors in the new route file.</verify>
  <done>GET /api/v1/products/:productId/options endpoint exists, authenticates via API key, validates product ID, returns option groups with choices in JSON format, returns empty array for products without groups, includes CORS and rate limit headers.</done>
</task>

<task type="auto">
  <name>Task 2: Extend widget type system with option group types</name>
  <files>packages/widget/src/types.ts</files>
  <action>
Add the following types to `packages/widget/src/types.ts`:

1. `OptionGroup` interface:
   - `id: string`
   - `name: string`
   - `requirement: 'REQUIRED' | 'OPTIONAL'`
   - `choices: OptionChoice[]`

2. `OptionChoice` interface:
   - `id: string`
   - `label: string`
   - `modifierType: 'FIXED' | 'PERCENTAGE'`
   - `modifierValue: number` (cents for FIXED, basis points for PERCENTAGE)
   - `isDefault: boolean`

3. `OptionSelection` interface:
   - `optionGroupId: string`
   - `choiceId: string`

4. `OptionGroupsApiResponse` interface (internal, for the new options endpoint):
   - `optionGroups: OptionGroup[]`

5. Extend `PriceApiResponse` with optional fields (backward compatible):
   - `basePrice?: number` (base price in cents before modifiers)
   - `optionModifiers?: OptionModifierInfo[]` (breakdown of applied modifiers)

6. Add `OptionModifierInfo` interface:
   - `optionGroup: string`
   - `choice: string`
   - `modifierType: 'FIXED' | 'PERCENTAGE'`
   - `modifierValue: number`
   - `appliedAmount: number`

7. Extend `DraftOrderApiResponse` with same optional fields:
   - `basePrice?: number`
   - `optionModifiers?: OptionModifierInfo[]`

Place these types in the "Internal types" section of the file, NOT in the public API exports section. The `OptionGroup`, `OptionChoice`, and `OptionSelection` types are internal to the widget — not exported to consumers.
  </action>
  <verify>Run `cd packages/widget && npx tsc --noEmit` to confirm no TypeScript errors.</verify>
  <done>Widget type system includes OptionGroup, OptionChoice, OptionSelection, OptionGroupsApiResponse, and OptionModifierInfo types. PriceApiResponse and DraftOrderApiResponse extended with optional breakdown fields.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit` from project root
2. Widget TypeScript compiles: `cd packages/widget && npx tsc --noEmit`
3. New route file follows same patterns as existing API routes (CORS, auth, rate limiting, RFC 7807 errors)
</verification>

<success_criteria>
- REST API endpoint `GET /api/v1/products/:productId/options` is implemented and type-checks
- Widget types include all option-related interfaces needed for Plans 02 and 03
- Both backward-compatible (PriceApiResponse/DraftOrderApiResponse extended with optional fields)
</success_criteria>

<output>
After completion, create `.planning/phases/14-widget-integration/14-01-SUMMARY.md`
</output>
