---
phase: 14-widget-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/api.v1.products.$productId.price.ts
  - app/routes/api.v1.draft-orders.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "FIXED modifier of 1500 cents ($15.00) added to base price of $400.00 results in $415.00 unit price (not $1,900)"
    - "PERCENTAGE modifier of 1000 basis points (10%) on base price $400.00 results in $440.00 unit price"
    - "Price endpoint without options still returns correct dollar price (backward compatible)"
    - "Draft orders endpoint applies same correct unit conversion for option modifiers"
    - "Response breakdown fields (basePrice, optionModifiers.appliedAmount) are in dollars, not cents"
  artifacts:
    - path: "app/routes/api.v1.products.$productId.price.ts"
      provides: "Price endpoint with correct dollars-to-cents conversion"
      contains: "Math.round"
    - path: "app/routes/api.v1.draft-orders.ts"
      provides: "Draft orders endpoint with correct dollars-to-cents conversion"
      contains: "Math.round"
  key_links:
    - from: "api.v1.products.$productId.price.ts"
      to: "option-price-calculator.server.ts"
      via: "basePriceCents converted from dollars"
      pattern: "Math\\.round.*\\*\\s*100"
---

<objective>
Fix unit mismatch bug: `calculatePrice()` returns dollars but `calculatePriceWithOptions()` expects cents.

Purpose: UAT test 3 failed — FIXED modifier 1500 (cents = $15.00) is added to 400 (dollars, not cents), producing $1,900 instead of $415.00. The base price must be converted to cents before option calculation, and converted back to dollars for the API response.

Output: Both price and draft-orders endpoints correctly convert between dollars and cents when applying option modifiers.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/services/option-price-calculator.server.ts
@app/services/price-calculator.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix unit mismatch in price endpoint and draft-orders endpoint</name>
  <files>
    app/routes/api.v1.products.$productId.price.ts
    app/routes/api.v1.draft-orders.ts
  </files>
  <action>
The root cause: `calculatePrice()` returns `cell.price` in **dollars** (e.g. 400 for $400.00). Both endpoints assign this to `basePriceCents` and pass it to `calculatePriceWithOptions()` which expects **cents**. FIXED modifier 1500 (cents = $15.00) gets added to 400 (dollars) = 1900, displayed as $1,900.

**In `app/routes/api.v1.products.$productId.price.ts`:**

1. After line 197 (`basePriceCents = calculatePrice(width, height, productMatrix.matrixData);`), rename `basePriceCents` to `basePriceDollars` on that line to clarify the unit. Then add a new line: `const basePriceCents = Math.round(basePriceDollars * 100);` to convert to cents for the option calculator.

2. In the options branch (around line 231-232), the result `priceBreakdown.totalCents` is in cents. Convert back to dollars for the response: change `unitPrice = priceBreakdown.totalCents;` to `unitPrice = priceBreakdown.totalCents / 100;`

3. In the no-options branch (around line 234-235), keep `unitPrice = basePriceDollars;` (was `basePriceCents` which was actually dollars — now renamed for clarity).

4. In the response breakdown section (around line 259), convert `basePriceCents` back to dollars: change `responseBody.basePrice = priceBreakdown.basePriceCents;` to `responseBody.basePrice = priceBreakdown.basePriceCents / 100;`

5. In the response breakdown modifiers (around line 269), convert `appliedAmountCents` to dollars: change `appliedAmount: m.appliedAmountCents,` to `appliedAmount: m.appliedAmountCents / 100,`

**In `app/routes/api.v1.draft-orders.ts`:**

Apply the exact same pattern:

1. Line 214: rename `basePriceCents` to `basePriceDollars`, add `const basePriceCents = Math.round(basePriceDollars * 100);`

2. Around line 256: change `unitPrice = priceBreakdown.totalCents;` to `unitPrice = priceBreakdown.totalCents / 100;`

3. Around line 259: change `unitPrice = basePriceCents;` to `unitPrice = basePriceDollars;`

4. Around line 370: change `responseBody.basePrice = priceBreakdown.basePriceCents;` to `responseBody.basePrice = priceBreakdown.basePriceCents / 100;`

5. Around line 380: change `appliedAmount: m.appliedAmountCents,` to `appliedAmount: m.appliedAmountCents / 100,`

**IMPORTANT: Do NOT modify `option-price-calculator.server.ts`.** That service is correct — it operates in cents as designed. The fix is only in the two route files that call it.

**IMPORTANT: Do NOT change the no-options code path behavior.** Without options, `calculatePrice()` returns dollars and the API has always returned dollars. That path must continue working identically.
  </action>
  <verify>
Run TypeScript compilation to verify no type errors:
```bash
cd /Users/robinkonijnendijk/Desktop/quote-flow && npx tsc --noEmit
```

Run existing option price calculator tests to confirm they still pass:
```bash
cd /Users/robinkonijnendijk/Desktop/quote-flow && npx vitest run app/services/option-price-calculator.server.test.ts
```

Manual trace verification — walk through the math for the UAT scenario:
- `calculatePrice()` returns 400 (dollars for $400.00 base)
- `basePriceDollars` = 400
- `basePriceCents` = Math.round(400 * 100) = 40000
- FIXED modifier 1500 cents → `calculatePriceWithOptions(40000, [{type:'FIXED', value:1500, ...}])`
- totalCents = 40000 + 1500 = 41500
- `unitPrice` = 41500 / 100 = 415.00 ✓

Verify the no-options path is unchanged:
- `calculatePrice()` returns 400
- `basePriceDollars` = 400
- `unitPrice` = 400 (dollars, same as before) ✓
  </verify>
  <done>
- FIXED modifier 1500 (cents) on $400 base produces $415.00 unit price (not $1,900)
- PERCENTAGE modifier 1000 bps (10%) on $400 base produces $440.00 unit price
- No-options path returns identical dollar amounts as before
- Both endpoints (price and draft-orders) have consistent fix
- TypeScript compiles without errors
- Existing tests pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Existing option price calculator tests pass: `npx vitest run app/services/option-price-calculator.server.test.ts`
3. Math trace: base $400 + FIXED $15.00 = $415.00 (not $1,900)
4. Math trace: base $400 + 10% = $440.00 (not $440)
5. No-options path unchanged: base $400 returns $400
6. Response breakdown basePrice and appliedAmount fields are in dollars
</verification>

<success_criteria>
- UAT Test 3 gap closed: FIXED modifier correctly applies as cents addition to cents-converted base price, result converted back to dollars
- Both price endpoint and draft-orders endpoint have consistent unit handling
- No-options backward compatibility preserved (dollar values unchanged)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-widget-integration/14-04-SUMMARY.md`
</output>
