---
phase: 07-publish-widget-to-npm
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: []
autonomous: false
user_setup:
  - service: npm
    why: "Publishing package to npm registry"
    env_vars: []
    dashboard_config:
      - task: "Ensure @pricing-matrix scope is available (or create npm org)"
        location: "npmjs.com -> Settings -> Organizations (if scoped to org)"

must_haves:
  truths:
    - "npm install @pricing-matrix/widget succeeds in a fresh project"
    - "Published package includes TypeScript types, ES module, UMD bundle, and README"
    - "Package version on npmjs.com is 0.1.0"
  artifacts:
    - path: "https://www.npmjs.com/package/@pricing-matrix/widget"
      provides: "Public npm package listing"
      contains: "@pricing-matrix/widget"
  key_links:
    - from: "npmjs.com registry"
      to: "packages/widget/dist/*"
      via: "npm publish uploads tarball"
      pattern: "npm publish"
---

<objective>
Authenticate with npm and publish @pricing-matrix/widget as a public scoped package.

Purpose: Make the widget installable via `npm install @pricing-matrix/widget` for any developer building a headless Shopify storefront.
Output: Package live on npmjs.com at version 0.1.0 with all metadata, types, and documentation.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-publish-widget-to-npm/07-RESEARCH.md
@.planning/phases/07-publish-widget-to-npm/07-01-SUMMARY.md

@packages/widget/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check npm authentication status</name>
  <files></files>
  <action>
    Run `npm whoami` to check if user is already authenticated with npm.

    If authenticated: Note the username and proceed to Task 3 (skip the checkpoint).
    If NOT authenticated (error "need to log in"): Proceed to Task 2 checkpoint.

    Also verify the @pricing-matrix scope is available:
    - Run `npm view @pricing-matrix/widget` — if it returns 404/not found, the name is available.
    - If it returns package info, someone already published this name — STOP and inform user.
  </action>
  <verify>
    `npm whoami` output or error is captured. Scope availability is confirmed.
  </verify>
  <done>
    npm auth status is known. Package name @pricing-matrix/widget is confirmed available (or already owned by user).
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: npm login (requires 2FA)</name>
  <action>
    User must authenticate with npm registry. This requires browser-based login with 2FA (as of Dec 2025, npm uses session-based auth with 2-hour tokens).
  </action>
  <instructions>
    Run this command in your terminal:

    ```bash
    cd packages/widget && npm login
    ```

    This will:
    1. Open your browser to npmjs.com login
    2. Prompt for 2FA code
    3. Create a session token (valid ~2 hours)

    After login, verify with: `npm whoami`

    IMPORTANT: If you don't have an npm account, create one at https://www.npmjs.com/signup first.

    IMPORTANT: The `@pricing-matrix` scope must be available. If publishing under a scope, you either need:
    - A personal account where the scope matches your username (e.g., @yourusername/widget), OR
    - An npm organization named "pricing-matrix" that you own

    If you cannot use the @pricing-matrix scope, let Claude know your preferred package name.
  </instructions>
  <resume-signal>Type "logged in" once `npm whoami` shows your username, or provide an alternative package name if scope is unavailable.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Publish to npm and verify</name>
  <files></files>
  <action>
    Run from `packages/widget/` directory:

    1. Final pre-publish verification:
       ```bash
       npm run build
       npm pack --dry-run
       ```
       Confirm output matches expectations from Plan 01.

    2. Publish the package:
       ```bash
       npm publish --access public
       ```
       The `--access public` flag is required on first publish of a scoped package.
       The `publishConfig.access: "public"` in package.json provides a fallback, but explicit flag is safer for first publish.

       If publish fails with "402 Payment Required": The scope is set to private. Re-run with `--access public`.
       If publish fails with "403 Forbidden": User doesn't own the scope. Need to create npm org or change package name.
       If publish fails with auth error: Go back to Task 2.

    3. Verify the publish succeeded:
       ```bash
       npm view @pricing-matrix/widget
       ```
       Should show version 0.1.0, description, and all metadata.

    4. Test installation in a temporary directory:
       ```bash
       TMPDIR=$(mktemp -d)
       cd "$TMPDIR"
       npm init -y
       npm install @pricing-matrix/widget
       ls node_modules/@pricing-matrix/widget/dist/
       cat node_modules/@pricing-matrix/widget/package.json | grep version
       rm -rf "$TMPDIR"
       ```
       Verify: dist/ files are present, version is 0.1.0.

    If the user provided an alternative package name (not @pricing-matrix/widget):
    - Update package.json name field first
    - Rebuild
    - Then publish with the new name
  </action>
  <verify>
    - `npm view @pricing-matrix/widget version` returns "0.1.0"
    - `npm install @pricing-matrix/widget` succeeds in a fresh directory
    - Installed package contains dist/price-matrix-widget.es.js, dist/price-matrix-widget.umd.js, dist/index.d.ts
  </verify>
  <done>
    @pricing-matrix/widget@0.1.0 is live on npmjs.com. `npm install @pricing-matrix/widget` works. Package includes TypeScript types, ES + UMD builds, README, and LICENSE.
  </done>
</task>

</tasks>

<verification>
1. `npm view @pricing-matrix/widget` shows the published package with correct metadata
2. `npm install @pricing-matrix/widget` succeeds in a fresh project
3. Installed package contains dist/ with ES module, UMD, and .d.ts files
4. Package version is 0.1.0
5. npmjs.com page shows README content and license
</verification>

<success_criteria>
- Package published to npm registry as @pricing-matrix/widget@0.1.0
- `npm install @pricing-matrix/widget` works from any project
- Published tarball includes TypeScript types, ES + UMD builds, README, and LICENSE
- npmjs.com package page displays README and correct metadata
</success_criteria>

<output>
After completion, create `.planning/phases/07-publish-widget-to-npm/07-02-SUMMARY.md`
</output>
