---
phase: 10-e2e-production-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Fresh store installs app via direct link and lands on embedded dashboard"
    - "Merchant creates a price matrix with breakpoints and assigns it to a product"
    - "REST API returns correct price for given dimensions using the created matrix"
    - "REST API creates a Draft Order with the correct custom price"
    - "Draft Order appears in Shopify admin with correct line item pricing and dimensions"
  artifacts: []
  key_links:
    - from: "Shopify admin embedded dashboard"
      to: "quote-flow-one.vercel.app"
      via: "OAuth install flow"
      pattern: "install link → OAuth → embedded app"
    - from: "REST price API"
      to: "matrix data in Neon DB"
      via: "API key authentication + breakpoint lookup"
      pattern: "curl .*/api/v1/products/.*/price"
    - from: "REST draft-order API"
      to: "Shopify Draft Order"
      via: "GraphQL mutation with custom line item"
      pattern: "curl .*/api/v1/draft-orders"
---

<objective>
Verify the complete end-to-end production flow from app installation through Draft Order creation on a fresh Shopify development store.

Purpose: Confirm VERIFY-01 — the full merchant-to-customer journey works in production using real Shopify infrastructure, Vercel deployment, and Neon database.
Output: UAT results documenting pass/fail for each step of the E2E flow.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-shopify-partner-dashboard-registration/09-02-SUMMARY.md
@.planning/phases/08-production-deploy-to-vercel/08-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Install app on fresh development store and create test matrix</name>
  <what-built>
    Production app (QuoteFlow) deployed at quote-flow-one.vercel.app with OAuth install flow verified in Phase 09.
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    - Use a fresh development store (NOT pricing-app-3.myshopify.com or dynamic-pricing-demo.myshopify.com)
    - If no third dev store exists, uninstall QuoteFlow from dynamic-pricing-demo.myshopify.com first and reinstall

    **Step 1: Install the app**
    1. Open the Partner Dashboard install link for QuoteFlow
    2. Select the fresh development store
    3. Approve the OAuth scopes (write_products, read_customers, write_draft_orders)
    4. Expected: Redirected to embedded dashboard inside Shopify admin with Polaris UI

    **Step 2: Copy the API key**
    1. The dashboard should display the store's API key
    2. Copy and save it — you will need it for REST API testing in Task 2
    3. Expected: API key displayed (e.g., `pm_live_...`)

    **Step 3: Create a price matrix**
    1. Click "Create matrix" (or similar button)
    2. Name it "E2E Test Glass 6mm"
    3. Select the 3x3 template (Small)
    4. Edit the breakpoints and prices to known values. Example:
       - Width breakpoints: 50, 100, 150 (in the store's unit)
       - Height breakpoints: 50, 100, 150
       - Fill in prices (e.g., 10, 20, 30 / 25, 35, 45 / 40, 55, 70)
    5. Save the matrix
    6. Expected: Matrix saves without errors, toast confirms success

    **Step 4: Create a test product and assign the matrix**
    1. In Shopify admin, create a simple product (e.g., "E2E Test Product")
    2. Back in QuoteFlow, open the matrix editor
    3. Use the product picker to assign "E2E Test Product" to this matrix
    4. Expected: Product appears in the assigned products section

    **Record the following for Task 2:**
    - Store domain (e.g., `your-store.myshopify.com`)
    - API key (masked in UAT doc)
    - Product GID (e.g., `gid://shopify/Product/1234567890` — find in Shopify admin URL)
    - Matrix name and exact breakpoint/price values used
    - Unit preference (cm or mm) shown in dashboard
  </how-to-verify>
  <resume-signal>
    Provide the store domain, API key, product GID, matrix breakpoints/prices, and unit — then type "approved" if all steps passed, or describe the exact failure.
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Test REST API and verify Draft Order in Shopify admin</name>
  <what-built>
    REST API endpoints deployed at quote-flow-one.vercel.app (price endpoint from Phase 04, Draft Order endpoint from Phase 05).
  </what-built>
  <how-to-verify>
    **Use the values recorded from Task 1 (store domain, API key, product GID, matrix prices).**

    **Step 1: Test the Price API**
    Run curl to fetch price for dimensions that match a matrix cell:

    ```bash
    curl -s -X GET \
      'https://quote-flow-one.vercel.app/api/v1/products/{PRODUCT_GID}/price?width={WIDTH}&height={HEIGHT}&quantity=1' \
      -H 'X-API-Key: {YOUR_API_KEY}' \
      -H 'Content-Type: application/json' | python3 -m json.tool
    ```

    Replace `{PRODUCT_GID}`, `{WIDTH}`, `{HEIGHT}`, `{YOUR_API_KEY}` with Task 1 values.
    Use dimensions that match an exact breakpoint intersection.

    Expected: 200 response with `price` matching the matrix cell value, correct `currency`, correct `unit`.

    **Step 2: Test the Price API with in-between dimensions**
    Run curl with dimensions that fall between breakpoints:

    ```bash
    curl -s -X GET \
      'https://quote-flow-one.vercel.app/api/v1/products/{PRODUCT_GID}/price?width=75&height=75&quantity=2' \
      -H 'X-API-Key: {YOUR_API_KEY}' \
      -H 'Content-Type: application/json' | python3 -m json.tool
    ```

    Expected: Price snaps UP to the next breakpoint (e.g., 75 rounds up to 100). Verify the returned price matches the (100, 100) cell. Total should be price * quantity.

    **Step 3: Create a Draft Order via API**

    ```bash
    curl -s -X POST \
      'https://quote-flow-one.vercel.app/api/v1/draft-orders' \
      -H 'X-API-Key: {YOUR_API_KEY}' \
      -H 'Content-Type: application/json' \
      -d '{
        "productId": "{PRODUCT_GID}",
        "width": {WIDTH},
        "height": {HEIGHT},
        "quantity": 1
      }' | python3 -m json.tool
    ```

    Expected: 201 response with `draftOrderId`, `name` (e.g., #D1), `checkoutUrl`, `price` matching the matrix lookup.

    **Step 4: Verify Draft Order in Shopify Admin**
    1. Navigate to Shopify admin for the test store
    2. Go to Orders > Drafts
    3. Find the Draft Order created in Step 3 (match by name/number)
    4. Expected:
       - Line item shows custom title with dimensions (e.g., "E2E Test Glass 6mm - 100x200 cm")
       - Price matches the matrix cell value
       - Quantity matches what was sent

    **Record for UAT:**
    - Price API response (exact JSON)
    - Draft Order API response (exact JSON, mask API key)
    - Draft Order ID from Shopify admin
    - Screenshot or confirmation that Draft Order line item is correct
  </how-to-verify>
  <resume-signal>
    Paste the curl responses and confirm the Draft Order appears correctly in Shopify admin.
    Type "approved" if all 4 steps passed, or describe exact failure with error messages/responses.
  </resume-signal>
</task>

</tasks>

<verification>
- App installs on a fresh store without errors
- Embedded dashboard renders Polaris UI inside Shopify admin
- Matrix creation, editing, and product assignment all work
- REST price API returns correct price for exact breakpoint dimensions
- REST price API snaps up to next breakpoint for in-between dimensions
- REST Draft Order API creates a Draft Order with correct custom pricing
- Draft Order visible in Shopify admin with correct line item details
</verification>

<success_criteria>
All 4 verification steps pass on production URLs (quote-flow-one.vercel.app) using a fresh development store with real Shopify data. The complete merchant journey (install -> configure -> price -> order) works end-to-end without manual intervention beyond the initial setup.
</success_criteria>

<output>
After completion, create `.planning/phases/10-e2e-production-verification/10-01-SUMMARY.md`
</output>
