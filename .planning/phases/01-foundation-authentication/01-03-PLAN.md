---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/routes/app.error.tsx
  - prisma/migrations/
autonomous: false

must_haves:
  truths:
    - "Dev server starts and serves the app at localhost"
    - "Database migrations applied and tables exist"
    - "Error page renders for failed OAuth with retry button"
    - "Merchant can verify full install flow end-to-end"
  artifacts:
    - path: "app/routes/app.error.tsx"
      provides: "Friendly error page for OAuth failures"
      contains: "Try installing again"
    - path: "prisma/migrations/"
      provides: "Applied database migrations"
  key_links:
    - from: "app/routes/app.error.tsx"
      to: "OAuth flow"
      via: "error boundary catches auth failures"
      pattern: "ErrorBoundary"
---

<objective>
Run database migrations, add error handling for failed OAuth, and verify the complete install flow end-to-end with a human checkpoint.

Purpose: Ensures the foundation actually works — OAuth installs, sessions persist, dashboard loads, and error cases are handled gracefully.

Output: Migrated database, error handling page, and human-verified install flow.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run migrations and add OAuth error handling</name>
  <files>
    prisma/migrations/
    app/routes/app.error.tsx
  </files>
  <action>
    Run database migration:
    - Execute `npx prisma migrate dev --name init` to create and apply the initial migration
    - Verify tables exist by running `npx prisma db pull` or checking migration output

    Create `app/routes/app.error.tsx` (or add ErrorBoundary to app.tsx layout):
    - Friendly error page for OAuth and general app failures
    - Per CONTEXT.md: show a friendly error page with a "Try installing again" button
    - Use Polaris Page and Card components
    - Title: "Something went wrong"
    - Body: "We couldn't complete the installation. This usually resolves by trying again."
    - Primary action button: "Try installing again" — links back to the app install URL
    - Secondary: "Contact support" link (placeholder mailto or URL)
    - Export as ErrorBoundary from the app layout route OR as a dedicated error route

    Also ensure the app.tsx layout route has an ErrorBoundary that catches authentication errors and renders the friendly error page rather than a generic Remix error.

    Start the dev server to verify everything compiles:
    - `npm run dev` should start without errors
    - If Shopify CLI is available, use `shopify app dev` for the tunnel + dev server
  </action>
  <verify>
    - `npx prisma migrate dev --name init` succeeds (or migrations already applied)
    - Database has Store and GdprRequest tables
    - Error boundary component renders with "Try installing again" button
    - `npm run dev` starts without crashes
  </verify>
  <done>
    Database migrated with Store and GdprRequest tables. Error boundary provides friendly OAuth failure recovery. Dev server starts successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 foundation: Shopify Remix app with OAuth, session token auth, GDPR webhooks, API key generation, dashboard with welcome card, and error handling.
  </what-built>
  <how-to-verify>
    1. **Start the app:** Run `shopify app dev` (or `npm run dev` + ngrok tunnel)
    2. **Install the app:** Open the install URL in your Shopify development store. Complete the OAuth flow.
    3. **Check dashboard:** After install, you should see the embedded dashboard inside Shopify admin with:
       - A welcome card saying "You're all set! Here's how to get started" with 3 steps
       - An API key section showing your full key with a warning banner to save it
       - An empty matrices section with a "Create matrix" button
    4. **Test API key copy:** Click "Copy" on the API key. Verify it copies to clipboard. Check for toast notification "API key copied to clipboard".
    5. **Test welcome dismiss:** Click "Dismiss" on the welcome card. Refresh the page. Welcome card should stay hidden.
    6. **Test API key regeneration:** Click "Regenerate" on the API key. Confirm in the modal. Verify new key is displayed with warning banner.
    7. **Test GDPR webhooks (optional):** Use Shopify Partner Dashboard webhook testing tool to send test CUSTOMERS_DATA_REQUEST webhook. Check server logs for receipt.
    8. **Test session persistence:** Navigate away from the app in Shopify admin, then navigate back. Dashboard should load without re-authentication prompt.
  </how-to-verify>
  <resume-signal>Type "approved" if the install flow, dashboard, and key management work correctly. Otherwise, describe what failed.</resume-signal>
</task>

</tasks>

<verification>
1. Database tables created successfully
2. Error page renders for authentication failures
3. Full OAuth install flow works end-to-end
4. Dashboard shows welcome card, API key, and empty state
5. API key copy/regenerate functions correctly
6. GDPR webhooks respond (if tested)
</verification>

<success_criteria>
- Human verifies: OAuth install completes successfully
- Human verifies: Dashboard renders with welcome card, API key, and empty state
- Human verifies: API key copy and regenerate work
- Human verifies: Welcome card dismissal persists
- Database migrations applied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
