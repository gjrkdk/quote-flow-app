---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/routes/app._index.tsx
  - app/routes/app.tsx
  - app/routes/app.settings.tsx
  - app/utils/api-key.server.ts
  - app/hooks/afterInstall.server.ts
autonomous: true

must_haves:
  truths:
    - "Merchant sees a welcome card with onboarding steps on first visit after install"
    - "Merchant can view their masked API key and copy the full key to clipboard"
    - "Merchant can regenerate their API key and sees the new key once"
    - "Welcome card can be dismissed and stays dismissed across sessions"
    - "Dashboard shows empty state with Create CTA when no matrices exist"
    - "Toast notifications confirm actions like key copy and key regeneration"
  artifacts:
    - path: "app/routes/app._index.tsx"
      provides: "Main dashboard with welcome card, API key display, empty state"
      contains: "Page"
    - path: "app/routes/app.tsx"
      provides: "App layout wrapper with navigation shell"
      contains: "Outlet"
    - path: "app/utils/api-key.server.ts"
      provides: "API key generation, hashing, and verification utilities"
      exports: ["generateApiKey", "hashApiKey", "verifyApiKey"]
    - path: "app/hooks/afterInstall.server.ts"
      provides: "Post-install hook that creates Store record and generates API key"
      exports: ["ensureStoreExists"]
  key_links:
    - from: "app/routes/app._index.tsx"
      to: "app/utils/api-key.server.ts"
      via: "loader/action calls for key display and regeneration"
      pattern: "generateApiKey|hashApiKey"
    - from: "app/routes/app._index.tsx"
      to: "app/hooks/afterInstall.server.ts"
      via: "loader calls ensureStoreExists on every dashboard load"
      pattern: "ensureStoreExists"
    - from: "app/routes/app._index.tsx"
      to: "prisma store model"
      via: "reads onboardingCompleted for welcome card visibility"
      pattern: "onboardingCompleted"
---

<objective>
Build the merchant-facing dashboard with welcome card onboarding, API key display/copy/regeneration, and empty state for matrices.

Purpose: This is the first thing merchants see after installing. It delivers the API key (INFRA-04) and provides the onboarding experience defined in CONTEXT.md.

Output: A functional embedded dashboard with welcome card, API key management, and Polaris-native UI.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key utilities and post-install hook</name>
  <files>
    app/utils/api-key.server.ts
    app/hooks/afterInstall.server.ts
  </files>
  <action>
    Create `app/utils/api-key.server.ts`:
    - `generateApiKey()`: Uses `crypto.randomBytes(32).toString('hex')` to produce a 64-char hex string. Returns the plaintext key.
    - `hashApiKey(apiKey: string)`: SHA-256 hash of the key, returns hex digest. Used for storage.
    - `verifyApiKey(providedKey: string, storedHash: string)`: Hashes the provided key and compares with timing-safe comparison using `crypto.timingSafeEqual`. Returns boolean.
    - `getApiKeyPrefix(apiKey: string)`: Returns first 8 characters of the key for display identification (e.g., "pm_a1b2c3d4").
    - Add a prefix "pm_" (price matrix) to generated keys for easy identification: `"pm_" + crypto.randomBytes(32).toString('hex')`. Adjust hashApiKey and verifyApiKey to work with the full prefixed key.

    Create `app/hooks/afterInstall.server.ts`:
    - Export `ensureStoreExists(shop: string, accessToken: string | undefined)`:
      - Check if Store record exists for this shop
      - If not: generate API key, hash it, create Store record with apiKeyHash, apiKeyPrefix, shop, accessToken, scope
      - Return `{ store, isNewInstall: boolean, apiKey?: string }` — apiKey only returned on new install (plaintext shown once)
      - If exists: update accessToken if changed (reinstall scenario), return existing store with isNewInstall: false
    - Import prisma from db.server, generateApiKey/hashApiKey/getApiKeyPrefix from api-key.server

    IMPORTANT: The plaintext API key is only available during the install session. After that, only the hash is stored. The dashboard must handle showing the key on first load after install.
  </action>
  <verify>
    - `api-key.server.ts` exports generateApiKey, hashApiKey, verifyApiKey, getApiKeyPrefix
    - `afterInstall.server.ts` exports ensureStoreExists
    - TypeScript compiles without errors: `npx tsc --noEmit` on these files (or full build)
  </verify>
  <done>
    API key utility functions generate cryptographically secure prefixed keys, hash for storage, and verify with timing-safe comparison. Post-install hook creates Store records on first install and preserves data on reinstall.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build dashboard with welcome card, API key display, and empty state</name>
  <files>
    app/routes/app.tsx
    app/routes/app._index.tsx
    app/routes/app.settings.tsx
  </files>
  <action>
    Create `app/routes/app.tsx` (layout route):
    - Import AppProvider from @shopify/shopify-app-remix/react
    - Import NavMenu from @shopify/app-bridge-react
    - Render AppProvider wrapping Outlet
    - Add NavMenu with navigation items: "Dashboard" (/) and "Settings" (/app/settings)
    - Load polarisStylesheetUrl in links function

    Create `app/routes/app._index.tsx` (main dashboard):

    LOADER:
    - Call `authenticate.admin(request)` to get session
    - Call `ensureStoreExists(session.shop, session.accessToken)` from afterInstall hook
    - If isNewInstall is true, pass apiKey (plaintext) to frontend via loader data — this is the ONE time the merchant sees the full key
    - Load store record to check onboardingCompleted status
    - Return: { shop: session.shop, store (with onboardingCompleted, apiKeyPrefix), newApiKey (only on first install, null otherwise) }

    ACTION (handles form submissions):
    - "dismiss-welcome": Set store.onboardingCompleted = true. Return success with Toast message.
    - "regenerate-key": Generate new API key, hash it, update store record with new apiKeyHash and apiKeyPrefix. Return new plaintext key in action data. Use Polaris modal for confirmation before regeneration ("This will invalidate your current key. Are you sure?").
    - "copy-key": No server action needed (client-side clipboard). But if the key was just generated (from newApiKey or regeneration), it's available in frontend state.

    UI COMPONENTS (all Polaris):

    1. **Welcome Card** (shown when !onboardingCompleted):
       - Polaris `CalloutCard` or `Card` component
       - Title: "You're all set! Here's how to get started"
       - Tone: friendly and encouraging (per CONTEXT.md)
       - 3 steps as a simple numbered list:
         1. "Create your first price matrix" (links to /app — will become matrix page in Phase 2)
         2. "Copy your API key for storefront integration" (scrolls to or highlights API key section)
         3. "Add the widget to your storefront" (links to placeholder docs URL)
       - Include a link to documentation (placeholder URL: "https://docs.example.com" for v1)
       - "Dismiss" button that submits form action "dismiss-welcome"
       - Use Polaris Toast to confirm: "Welcome guide dismissed"

    2. **API Key Section**:
       - Polaris `Card` with title "API Key"
       - If newApiKey exists (just installed or just regenerated): show full key in a `TextField` (readonly) with prominent "Copy" button. Show `Banner` with tone="warning": "Save this key now. You won't be able to see it again."
       - Normal state: show masked key display: `pm_a1b2...` (prefix + "..." ) — use apiKeyPrefix
       - "Copy" button (only available when full key is visible): copies to clipboard, shows Toast "API key copied to clipboard"
       - "Regenerate" button: opens Polaris `Modal` confirming "Regenerating will invalidate your current API key. Any storefronts using the current key will stop working. Continue?" with "Regenerate" (destructive) and "Cancel" buttons
       - After regeneration, show the new full key with the same warning banner

    3. **Matrices Empty State**:
       - Polaris `Card` with title "Price Matrices"
       - Simple text: "You haven't created any price matrices yet. Create a matrix to start offering dimension-based pricing."
       - "Create matrix" primary button (links to /app — will be updated to /app/matrices/new in Phase 2)
       - NO illustration (per CONTEXT.md decision)

    4. **Page Layout**:
       - Polaris `Page` with title "Dashboard"
       - Stack welcome card, API key section, and matrices empty state vertically
       - Use `BlockStack` (formerly `Stack vertical`) with gap

    Use `shopify.toast.show()` from App Bridge for all toast notifications (API key copied, welcome dismissed, key regenerated, errors).

    Create `app/routes/app.settings.tsx`:
    - Placeholder settings page (for Phase 1, just a Page with title "Settings" and a text note "Settings will be available in a future update")
    - Call authenticate.admin(request) in loader

    IMPORTANT CONTEXT.md decisions to honor:
    - Welcome card dismissed manually only (not auto-dismiss on step completion)
    - Tone: friendly and encouraging — "You're all set!" not "Configuration required"
    - Polaris Toast for all action confirmations
    - Empty state: simple text + CTA, no illustration
    - Pure Polaris styling (no custom CSS unless necessary)
  </action>
  <verify>
    - `npm run build` completes without errors
    - app/routes/app._index.tsx exports loader, action, and default component
    - app/routes/app.tsx exports default layout component
    - Component uses Polaris components (Page, Card, TextField, Button, Modal, Banner, BlockStack, Toast)
    - Welcome card has dismiss functionality
    - API key section has copy and regenerate functionality
  </verify>
  <done>
    Dashboard renders with: (1) dismissible welcome card with 3 onboarding steps and friendly tone, (2) API key section with masked display, copy-to-clipboard, and regeneration with confirmation modal, (3) empty state for matrices with Create CTA. All actions use Polaris Toast notifications. Welcome dismissal persists via database.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Dashboard page renders Polaris components (Page, Card, Banner, Button, Modal, TextField)
3. Welcome card shows on first visit, can be dismissed, stays dismissed
4. API key displayed on first install with copy functionality
5. API key regeneration shows confirmation modal and reveals new key
6. Empty state for matrices shows text and Create CTA
7. Toast notifications fire for: copy, dismiss, regenerate actions
</verification>

<success_criteria>
- Full dashboard UI built with Polaris components
- API key generated on install, shown once, stored as hash
- Welcome card with 3 onboarding steps, dismissible, persists in DB
- API key copy/regenerate with appropriate warnings and toasts
- Empty matrix state with Create button
- Build passes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
