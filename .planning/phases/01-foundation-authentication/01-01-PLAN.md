---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - shopify.app.toml
  - app/shopify.server.ts
  - app/db.server.ts
  - app/routes/webhooks.tsx
  - app/routes/auth.$.tsx
  - app/routes/auth.login/route.tsx
  - app/root.tsx
  - prisma/schema.prisma
  - .env.example
  - vite.config.ts
  - remix.config.js
  - tsconfig.json
autonomous: true
user_setup:
  - service: shopify
    why: "OAuth app credentials for development"
    env_vars:
      - name: SHOPIFY_API_KEY
        source: "Shopify Partners Dashboard -> App -> Client credentials"
      - name: SHOPIFY_API_SECRET
        source: "Shopify Partners Dashboard -> App -> Client credentials"
    dashboard_config:
      - task: "Create app in Shopify Partners Dashboard"
        location: "partners.shopify.com -> Apps -> Create app"
      - task: "Set App URL and Allowed redirection URLs"
        location: "Partners Dashboard -> App setup -> URLs"
  - service: postgresql
    why: "Session storage and app data"
    env_vars:
      - name: DATABASE_URL
        source: "PostgreSQL provider (Vercel Postgres, Neon, Supabase, or local)"

must_haves:
  truths:
    - "Shopify Remix app scaffolded with all dependencies installed and dev server starts without errors"
    - "Prisma schema defines Store model with shop, apiKeyHash, onboardingCompleted fields and migrations run"
    - "shopify.server.ts configured with OAuth, PostgreSQL session storage, and all 4 webhooks registered"
    - "GDPR webhook route handles CUSTOMERS_DATA_REQUEST, CUSTOMERS_REDACT, SHOP_REDACT, and APP_UNINSTALLED topics"
    - "Database connection uses Vercel Fluid Compute pooling pattern for serverless deployment"
  artifacts:
    - path: "app/shopify.server.ts"
      provides: "Shopify app configuration with OAuth, session storage, webhooks"
      contains: "shopifyApp"
    - path: "app/db.server.ts"
      provides: "Prisma client singleton with Vercel connection pooling"
      contains: "PrismaClient"
    - path: "prisma/schema.prisma"
      provides: "Store model with API key hash and onboarding state"
      contains: "model Store"
    - path: "app/routes/webhooks.tsx"
      provides: "Webhook handler for GDPR and app lifecycle events"
      contains: "authenticate.webhook"
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "DATABASE_URL"
  key_links:
    - from: "app/shopify.server.ts"
      to: "PostgreSQL session storage"
      via: "PostgreSQLSessionStorage(DATABASE_URL)"
      pattern: "PostgreSQLSessionStorage"
    - from: "app/db.server.ts"
      to: "prisma/schema.prisma"
      via: "PrismaClient with pg adapter"
      pattern: "PrismaClient"
    - from: "app/routes/webhooks.tsx"
      to: "app/shopify.server.ts"
      via: "authenticate.webhook"
      pattern: "authenticate\\.webhook"
---

<objective>
Scaffold the Shopify Remix app from the official template, configure PostgreSQL with Prisma (including Vercel connection pooling), set up OAuth authentication with session token support, and implement GDPR webhook handlers.

Purpose: This is the foundation plan. Every subsequent plan depends on a working Remix app with database, authentication, and webhook infrastructure.

Output: A running Shopify Remix app with OAuth install flow, session persistence, GDPR-compliant webhooks, and a Store model ready for API key storage.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Shopify Remix app and configure database</name>
  <files>
    package.json
    vite.config.ts
    tsconfig.json
    remix.config.js
    app/root.tsx
    app/entry.server.tsx
    app/db.server.ts
    prisma/schema.prisma
    .env.example
    shopify.app.toml
  </files>
  <action>
    Initialize the project using `npm create @shopify/app@latest -- --template remix` in the current directory (or scaffold manually if the CLI requires interactive input).

    If the CLI doesn't work non-interactively, manually scaffold the Remix app structure:
    1. Initialize package.json with the required Shopify dependencies
    2. Set up vite.config.ts with Remix plugin
    3. Set up tsconfig.json for TypeScript
    4. Create app/root.tsx with App Bridge script tag (`<script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>`) and `<meta name="shopify-api-key" content={...} />`
    5. Create app/entry.server.tsx for Remix server entry

    Install core dependencies:
    ```
    @shopify/shopify-app-remix
    @shopify/polaris
    @shopify/app-bridge-react (if needed by template)
    @remix-run/node @remix-run/react @remix-run/dev
    prisma @prisma/client
    @shopify/shopify-app-session-storage-postgresql
    ```

    Install Vercel pooling dependencies:
    ```
    @vercel/functions @prisma/adapter-pg pg
    ```

    Create `prisma/schema.prisma` with:
    - PostgreSQL datasource using `DATABASE_URL` env var
    - `generator client` with `previewFeatures = ["driverAdapters"]`
    - `Store` model:
      - `id` (String, @id, @default(cuid()))
      - `shop` (String, @unique) — the myshopify.com domain
      - `accessToken` (String, optional) — Shopify access token
      - `scope` (String, optional) — granted scopes
      - `apiKeyHash` (String, optional) — SHA-256 hash of the store's API key
      - `apiKeyPrefix` (String, optional) — first 8 chars of API key for identification
      - `onboardingCompleted` (Boolean, @default(false)) — welcome card dismissed
      - `createdAt` (DateTime, @default(now()))
      - `updatedAt` (DateTime, @updatedAt)
    - `GdprRequest` model:
      - `id` (String, @id, @default(cuid()))
      - `shop` (String)
      - `type` (String) — "data_request", "redact_customer", "redact_shop"
      - `payload` (Json)
      - `processedAt` (DateTime, optional)
      - `createdAt` (DateTime, @default(now()))

    Create `app/db.server.ts` with Vercel Fluid Compute pooling pattern:
    - Import Pool from 'pg', attachDatabasePool from '@vercel/functions', PrismaPg from '@prisma/adapter-pg', PrismaClient from '@prisma/client'
    - Create Pool with DATABASE_URL
    - Call attachDatabasePool(pool)
    - Create PrismaPg adapter
    - Export PrismaClient singleton (use global pattern to avoid multiple instances in dev)

    Create `.env.example` with all required env vars:
    ```
    SHOPIFY_API_KEY=
    SHOPIFY_API_SECRET=
    SCOPES=write_products,read_products,write_draft_orders,read_draft_orders
    SHOPIFY_APP_URL=http://localhost:3000
    DATABASE_URL=postgresql://user:password@localhost:5432/pricing_app
    ```

    Run `npx prisma generate` to generate the Prisma client.

    IMPORTANT: Do NOT use `@shopify/shopify-app-session-storage-prisma`. Use `@shopify/shopify-app-session-storage-postgresql` directly — it manages its own session table and does not conflict with Prisma models.
  </action>
  <verify>
    - `npm install` completes without errors
    - `npx prisma validate` passes
    - `npx prisma generate` succeeds
    - All files listed above exist
    - `.env.example` contains all required variables
  </verify>
  <done>
    Project scaffolded with all dependencies, Prisma schema validated with Store and GdprRequest models, database client configured with Vercel connection pooling pattern, and environment template created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Shopify OAuth, session storage, and webhook handlers</name>
  <files>
    app/shopify.server.ts
    app/routes/auth.$.tsx
    app/routes/auth.login/route.tsx
    app/routes/webhooks.tsx
  </files>
  <action>
    Create `app/shopify.server.ts`:
    - Import `@shopify/shopify-app-remix/adapters/node` at top
    - Import `ApiVersion`, `AppDistribution`, `DeliveryMethod`, `shopifyApp` from `@shopify/shopify-app-remix/server`
    - Import `PostgreSQLSessionStorage` from `@shopify/shopify-app-session-storage-postgresql`
    - Configure shopifyApp with:
      - apiKey from SHOPIFY_API_KEY env
      - apiSecretKey from SHOPIFY_API_SECRET env
      - apiVersion: `ApiVersion.January25` (use latest stable available in the package)
      - scopes from SCOPES env (split by comma)
      - appUrl from SHOPIFY_APP_URL env
      - authPathPrefix: "/auth"
      - sessionStorage: new PostgreSQLSessionStorage(DATABASE_URL)
      - distribution: AppDistribution.AppStore
      - webhooks object with 4 webhooks (all Http delivery to "/webhooks"):
        - CUSTOMERS_DATA_REQUEST
        - CUSTOMERS_REDACT
        - SHOP_REDACT
        - APP_UNINSTALLED
    - Export default shopify
    - Export `authenticate` as `shopify.authenticate`
    - Export `apiVersion` and `addDocumentResponseHeaders`

    Create `app/routes/auth.$.tsx`:
    - Simple catch-all route that calls `authenticate.admin(request)` from shopify.server
    - This handles OAuth callbacks automatically

    Create `app/routes/auth.login/route.tsx`:
    - Login route with Polaris login form (follows Shopify template pattern)
    - Loader validates shop param
    - Action initiates auth with loginErrorMessage handling

    Create `app/routes/webhooks.tsx`:
    - Export action function that calls `authenticate.webhook(request)`
    - Switch on `topic`:
      - `CUSTOMERS_DATA_REQUEST`: Log to GdprRequest table with type "data_request" and payload. Return 200.
      - `CUSTOMERS_REDACT`: Log to GdprRequest table with type "redact_customer" and payload. Return 200. (No customer data stored in v1, but log for audit.)
      - `SHOP_REDACT`: Delete Store record and all associated data for the shop. Log to GdprRequest table. Return 200.
      - `APP_UNINSTALLED`: Log uninstall event. Do NOT delete data (shop/redact comes 48 hours later for actual deletion). Return 200.
      - Default: Return 200 (unknown topics should not error).
    - Import prisma from db.server for database operations

    IMPORTANT: The `authenticate.webhook(request)` call from @shopify/shopify-app-remix automatically verifies HMAC signatures. Do NOT implement manual HMAC verification.
  </action>
  <verify>
    - `app/shopify.server.ts` exports `authenticate` and `default`
    - `app/routes/webhooks.tsx` handles all 4 webhook topics
    - `app/routes/auth.$.tsx` exists with authenticate.admin call
    - `npx remix vite:build` or `npm run build` completes without TypeScript errors
  </verify>
  <done>
    Shopify app configured with OAuth flow, PostgreSQL session storage, session token authentication, and GDPR-compliant webhook handlers. Auth routes handle OAuth callbacks. Webhook route processes all 4 mandatory topics with proper database operations.
  </done>
</task>

</tasks>

<verification>
1. `npm install` succeeds with all dependencies resolved
2. `npx prisma validate` confirms schema is valid
3. `npm run build` (or equivalent) completes without errors
4. All required files exist: shopify.server.ts, db.server.ts, webhooks.tsx, auth routes, schema.prisma
5. shopify.server.ts registers 4 webhooks (CUSTOMERS_DATA_REQUEST, CUSTOMERS_REDACT, SHOP_REDACT, APP_UNINSTALLED)
6. webhooks.tsx handles all 4 topics with database operations
</verification>

<success_criteria>
- Remix app builds without errors
- Prisma schema validates with Store and GdprRequest models
- Shopify config includes OAuth, session storage, and all webhooks
- GDPR webhook handlers implement proper data operations (not stubs)
- Connection pooling configured for Vercel deployment
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
